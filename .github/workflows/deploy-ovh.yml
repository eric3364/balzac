name: build-and-deploy
on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # RÉGLAGES À FOURNIR DANS Settings > Secrets and variables > Actions
    # - SFTP_HOST (ex: ssh.cluster0XX.hosting.ovh.net)
    # - SFTP_PORT (ex: 22)
    # - SFTP_USERNAME
    # - SFTP_PASSWORD  (laisser vide si vous utilisez la clé)
    # - SSH_PRIVATE_KEY (laisser vide si vous utilisez le mot de passe)
    env:
      HOST: ${{ secrets.SFTP_HOST }}
      PORT: ${{ secrets.SFTP_PORT }}
      USER: ${{ secrets.SFTP_USERNAME }}
      PASSWORD: ${{ secrets.SFTP_PASSWORD }}
      PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      REMOTE_DIR: /home/balzaci/www

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check build output
        run: |
          set -euxo pipefail
          test -d dist
          test -f dist/index.html
          du -sh dist || true
          ls -la dist | head -n 200

      - name: Install lftp
        run: sudo apt-get update && sudo apt-get install -y lftp

      - name: Prepare SSH key if provided
        run: |
          set -euxo pipefail
          if [ -n "${PRIVATE_KEY}" ]; then
            echo "${PRIVATE_KEY}" > id_rsa
            chmod 600 id_rsa
          fi

      - name: Probe remote (lists $REMOTE_DIR)
        run: |
          set -euxo pipefail
          echo "HOST=${HOST} USER=${USER} PORT=${PORT} REMOTE_DIR=${REMOTE_DIR}"
          if [ -n "${PASSWORD}" ]; then
            # Auth par mot de passe
            lftp -d -e "set sftp:auto-confirm yes; open -u ${USER},${PASSWORD} sftp://${HOST}:${PORT}; cls -l ${REMOTE_DIR}; bye"
          else
            # Auth par clé privée
            lftp -d -e "set sftp:auto-confirm yes; set sftp:connect-program \"ssh -i id_rsa -o StrictHostKeyChecking=no\"; open sftp://${USER}@${HOST}:${PORT}; cls -l ${REMOTE_DIR}; bye"
          fi

      - name: Deploy (mirror -R dist -> $REMOTE_DIR)
        run: |
          set -euxo pipefail
          # On évite d'écraser .htaccess
          if [ -n "${PASSWORD}" ]; then
            lftp -e "set sftp:auto-confirm yes; open -u ${USER},${PASSWORD} sftp://${HOST}:${PORT}; mirror -R --only-newer --verbose=2 --exclude-glob .htaccess dist ${REMOTE_DIR}; bye"
          else
            lftp -e "set sftp:auto-confirm yes; set sftp:connect-program \"ssh -i id_rsa -o StrictHostKeyChecking=no\"; open sftp://${USER}@${HOST}:${PORT}; mirror -R --only-newer --verbose=2 --exclude-glob .htaccess dist ${REMOTE_DIR}; bye"
          fi
