name: Deploy to OVH (SFTP)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm install --no-audit --legacy-peer-deps

      - name: Build
        run: npm run build

      - name: Prepare deploy folder
        shell: bash
        run: |
          rm -rf deploy
          mkdir -p deploy
          cp -r dist/* deploy/
          if [ -f public/.htaccess ]; then cp public/.htaccess deploy/.htaccess; fi

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Deploy via SFTP (lftp, no Docker)
        shell: bash
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_PORT: ${{ secrets.SFTP_PORT }}
          SFTP_USERNAME: ${{ secrets.SFTP_USERNAME }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
        run: |
          set -euo pipefail

          echo "Deploying ./deploy -> ${SFTP_HOST}:${SFTP_PORT}/www/"

          lftp -e "
            set net:max-retries 3;
            set net:reconnect-interval-base 5;
            set sftp:auto-confirm yes;
            set ssl:verify-certificate no;
            open -u ${SFTP_USERNAME},${SFTP_PASSWORD} sftp://${SFTP_HOST}:${SFTP_PORT};
            lcd deploy;
            cd www;
            mirror -R --verbose --only-newer --parallel=2 . .;
            bye;
          "
